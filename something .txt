import com.sun.mail.smtp.SMTPServer;
import com.sun.mail.smtp.SMTPHandler;
import com.sun.mail.smtp.SMTPHandlerFactory;

import javax.mail.Message;
import javax.mail.MessagingException;
import javax.mail.Session;
import javax.mail.internet.MimeMessage;
import java.io.*;
import java.util.Properties;

public class MailServer {

    public static void main(String[] args) {
        // Create an SMTP server listening on port 25
        SMTPServer server = new SMTPServer(new SimpleMessageHandlerFactory());

        // Start the server
        server.start();
        System.out.println("Mail server started on port 25...");
    }

    static class SimpleMessageHandlerFactory implements SMTPHandlerFactory {
        public SMTPHandler create(SMTPServer server) {
            return new SimpleMessageHandler(server);
        }
    }

    static class SimpleMessageHandler extends SMTPHandler {
        public SimpleMessageHandler(SMTPServer server) {
            super(server);
        }

        public void from(String sender) throws RejectException {
            System.out.println("Sender: " + sender);
        }

        public void recipient(String recipient) throws RejectException {
            System.out.println("Recipient: " + recipient);
        }

        public void data(InputStream data) throws IOException {
            // Do something with the message data
            System.out.println("Received message:");

            try {
                Properties properties = System.getProperties();
                Session session = Session.getDefaultInstance(properties);
                MimeMessage message = new MimeMessage(session, data);

                // Store the message in a file
                storeMessage(message);

                // Print message contents
                message.writeTo(System.out);

            } catch (MessagingException e) {
                e.printStackTrace();
            }
        }

        private void storeMessage(Message message) {
            try {
                // Store the message in a file (You can replace "messages.txt" with any file name you prefer)
                File file = new File("messages.txt");
                FileWriter fileWriter = new FileWriter(file, true); // Append mode
                BufferedWriter bufferedWriter = new BufferedWriter(fileWriter);
                message.writeTo(bufferedWriter);
                bufferedWriter.newLine();
                bufferedWriter.close();
                System.out.println("Message stored in messages.txt");
            } catch (IOException | MessagingException e) {
                e.printStackTrace();
            }
        }
    }
}
